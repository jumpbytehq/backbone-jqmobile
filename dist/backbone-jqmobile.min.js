window.jumpui=window.jumpui||{};jumpui.util=jumpui.util||{};jumpui.util.serializeForm=function($el){if($el==undefined||!$el.length){throw"No elements found in the form"}var data={},lookup=data;$el.find(':input[type!="checkbox"][type!="radio"], input:checked').each(function(){var named=this.name.replace(/\[([^\]]+)?\]/g,",$1").split(","),cap=named.length-1,i=0;if(named[0]){for(;i<cap;i++){lookup=lookup[named[i]]=lookup[named[i]]||(named[i+1]==""?[]:{})}if(lookup.length!=undefined){lookup.push($(this).val())}else{if(lookup[named[cap]]){if(_.isArray(lookup[named[cap]])){lookup[named[cap]].push($(this).val())}else{lookup[named[cap]]=[lookup[named[cap]],$(this).val()]}}else{if($(this).attr("data-field")=="array"){lookup[named[cap]]=[$(this).val()]}else{lookup[named[cap]]=$(this).val()}}}lookup=data}});return data};$(document).bind("mobileinit",function(){console.log("setting Jquery mobile on mobile init");$.mobile.ajaxEnabled=false;$.mobile.linkBindingEnabled=false;$.mobile.hashListeningEnabled=false;$.mobile.pushStateEnabled=false});window.jumpui=window.jumpui||{};jumpui.JqmApp=Backbone.Model.extend({initialize:function(){if(this.attributes.platform==undefined){throw"Platform is not specified for this app"}if(this.attributes.containerEl==undefined){throw"containerEl is not specified for this app"}_.extend(this,this.attributes);this.pages={};this.router=new Backbone.Router;this.platform.setup()},load:function(options){options=options||{};if(this.pages.length<=0){throw"No pages found in app"}$(this.containerEl).live("pageshow",function(event,ui){$(ui.prevPage).remove()});Backbone.history.start()},addPage:function(page){if(this.router==undefined){throw"Cannot add page before router is set in Application"}page.app=this;if(this.theme){page.attributes["data-theme"]=this.theme}this._registerPage(page);this.pages[page.name]=page},navigate:function(route){this.router.navigate(route,{trigger:true})},_registerPage:function(page){var self=this;this.router.route(page.route,page.name,function(){var args=arguments;if(page._load(args,$(self.containerEl))){if(self.currentPage){self.currentPage.visible=false}self.currentPage=page;self.currentPage.visible=true;$(page.el).trigger("jui-pageloaded")}else{console.log("Not loading page "+page.name+" as process returned negetive")}})},_jQChangePage:function(page){$.mobile.changePage($(page.el))}});jumpui.Platform=Backbone.Model.extend({initialize:function(){},setup:function(){}});jumpui.Platform.CORDOVA=new jumpui.Platform({});jumpui.Platform.WEB=new jumpui.Platform({});jumpui.internal={};jumpui.internal.AbstractView=Backbone.View.extend({initialize:function(){_.extend(this,this.options);if(this.ui){var self=this;if(!this._ui){this._ui=_.clone(this.ui)}var uiList=this._ui;_.each(uiList,function(value,key){console.log("fetch "+key+", "+value);self.ui[key]=self.$(value)})}if(this.init){this.init()}},close:function(){this.remove();this.unbind();if(this.onClose){this.onClose()}}});jumpui.template={};jumpui.template.engine={};jumpui.TemplateEngine=Backbone.Model.extend({parse:function(template,model){return template}});jumpui.template.engine.Underscore=jumpui.TemplateEngine.extend({parse:function(template,model){throw"UNDERSCORE not implemented yet"}});jumpui.template.engine.Handlebars=jumpui.TemplateEngine.extend({initialize:function(options){_.extend(this,options);var helpers=this.helpers||{};_.each(_.keys(helpers),function(helperKey){Handlebars.registerHelper(helperKey,helpers[helperKey])})},parse:function(template,model,fragments){var source=$("#"+template).html();return this.parseHtml(source,model,fragments)},parseHtml:function(source,model,fragments){var template=Handlebars.compile(source);model.fragments=fragments;return template(model)},registerPartial:function(partialKey){Handlebars.registerPartial(partialKey,$("#"+partialKey).html())}});jumpui.fragment={};jumpui.Fragment=jumpui.internal.AbstractView.extend({initialize:function(){jumpui.internal.AbstractView.prototype.initialize.apply(this,arguments);this.dataFragment=this.template},getModel:function(){return{}},render:function(){if(this.$el){this.$el.empty()}if($.isFunction(this.template)){this.$el.append(this.block.page.app.templateEngine.parseHtml(this.template(this.getModel()),this.getModel()));return}else if(this.template!=undefined){this.$el.append(this.block.page.app.templateEngine.parse(this.template,this.getModel()));return}if(this.getContent!=null){$(this.el).empty().append($(this.getContent()))}else{throw"Neither template nor getContent method found"}},createHtml:function(templateEngine,model){return"<"+this.tagName+" id='"+this.id+"'>"+templateEngine.parse(this.template,model)+"</"+this.tagName+">"},_setEl:function(element){this.setElement(element)}});jumpui.block={};jumpui.Block=jumpui.internal.AbstractView.extend({tagName:"div",fragments:{},initialize:function(){jumpui.internal.AbstractView.prototype.initialize.apply(this,arguments);var self=this;_.each(this.fragments,function(fragment){fragment.block=self})},render:function(){$(this.el).remove();this.setElement(jQuery(document.createElement("div")).attr(this.attributes));var $el=$(this.el);if(this.template){var self=this;var renderedFragments={};if($.isFunction(this.template)){$el.append(this.page.app.templateEngine.parseHtml(this.template(this.model),this.model,renderedFragments))}else if(this.template!=undefined){$el.append(this.page.app.templateEngine.parse(this.template,this.model,renderedFragments))}_.each(this.fragments,function(fragment,key){fragment._setEl(self.$("[data-fragment="+key+"]"));fragment.render()});return}if(this.getContent!=null){$(this.el).empty().append($(this.getContent()))}else{throw"Neither template nor getContent method found"}}});jumpui.block.Header=jumpui.Block.extend({className:"jump-header",attributes:{"data-role":"header"}});jumpui.block.Footer=jumpui.Block.extend({className:"jump-footer",attributes:{"data-role":"footer"}});jumpui.block.Content=jumpui.Block.extend({className:"jump-content",attributes:{"data-role":"content"}});jumpui.Page=Backbone.View.extend({tagName:"div",className:"jump-page",attributes:{"data-role":"page"},initialize:function(options){_.bindAll(this,"reload");if(options==undefined||options.name==undefined){throw"name property is compulsory"}if(options.prepare==undefined){throw"prepare property is compulsory"}_.extend(this,options);this.id=options.name;this.loaded=false;if(this.route==undefined){this.route=this.name}this.setBlocks(options.blocks||{});if(this.ui){if(!this._ui){this._ui=_.clone(this.ui)}var uiList=this._ui;_.each(uiList,function(value,key){console.log("fetch "+key+", "+value);self.ui[key]=self.$(value)})}if(this.init){this.init()}},setBlocks:function(blocks){var self=this;this.blocks=blocks;_.each(this.blocks,function(block){block.page=self})},isLoaded:function(){return false},_attachAndProcess:function(container){container.append(this.el);$(this.el).page();this.loaded=true},load:function(container){container.append(this.el);$(this.el).page();this.loaded=true},_createDom:function(){var self=this;this.setElement(jQuery(document.createElement("div")).attr(this.attributes));_.each(_.keys(this.blocks),function(blockKey){var block=self.blocks[blockKey];if(block.model==undefined){block.model={}}_.extend(block.model,block.page.model);block.render();$(self.el).append(block.el)})},render:function(){console.log("Rendering "+this.name,this);this._createDom();$(this.el).trigger("jui-pagerendered")},_load:function(args,container){var allowed=false;allowed=this.prepare.apply(this,args);if(!allowed){return}_.each(this.blocks,function(block){if(block.prepare){allowed=block.prepare.apply(block,args);return allowed}});if(!allowed){return false}this.render();this._attachAndProcess(container);this.app._jQChangePage(this);return true},reload:function(args){args=args||[];if(!$.isArray(args)){console.log("Arguments must be array",args);throw"Arguments must be array"}if(this.visible){console.log("reloading page "+this.name);return this._load(args,$(this.app.containerEl))}else{console.log("Unable to reload page "+this.name+", as page is not current/visible page");return false}}});jumpui.fragment=jumpui.fragment||{};jumpui.fragment.ListItem=Backbone.View.extend({tagName:"li",attribute:"name",model:undefined,templateEngine:undefined,initialize:function(options){this.templateEngine=options.templateEngine},render:function(){if(this.template){var modelJson=_.isFunction(this.model.toJSON)?this.model.toJSON():this.model;if($.isFunction(this.template)){this.$el.html(this.templateEngine.parseHtml(this.template(modelJson),modelJson))}else{this.$el.html(this.templateEngine.parse(this.template,modelJson))}}else{this.$el.html(this.model.get(this.attribute))}}});jumpui.fragment.formItems={text:jumpui.internal.AbstractView.extend({tagName:"input"}),password:jumpui.internal.AbstractView.extend({tagName:"input"}),number:jumpui.internal.AbstractView.extend({tagName:"input"}),submit:jumpui.internal.AbstractView.extend({tagName:"input",attributes:{type:"submit"},initialize:function(options){if(options.show===false){this.$el.hide()}this.$el.attr("value",options.value)}}),reset:jumpui.internal.AbstractView.extend({tagName:"input",attributes:{type:"reset"},initialize:function(options){if(options.show===false){this.$el.hide()}this.$el.attr("value",options.value)}}),range:jumpui.internal.AbstractView.extend({tagName:"input",attributes:{type:"range","data-highlight":true}}),select:jumpui.internal.AbstractView.extend({tagName:"select",initialize:function(options){var self=this;if(this.attributes&&this.attributes.options){_.each(this.attributes.options,function(option){var optionEl=$("<option>").attr("value",option).html(option);if(self.attributes.value==option){optionEl.attr("selected","selected")}self.$el.append(optionEl)})}}}),radiogroup:jumpui.internal.AbstractView.extend({tagName:"fieldset",attributes:{"data-role":"controlgroup"},initialize:function(options){var self=this;if(this.attributes.options){_.each(this.attributes.options,function(option){var optionEl=$("<input>").attr({type:"radio",value:option,name:self.attributes.name,id:option}).html(option);var labelEl=$("<label>").attr("for",option).html(option);if(self.attributes.value==option){optionEl.attr("checked","checked")}self.$el.append(optionEl);self.$el.append(labelEl)})}}}),checkboxgroup:jumpui.internal.AbstractView.extend({tagName:"fieldset",attributes:{"data-role":"controlgroup"},initialize:function(options){var self=this;if(this.attributes.options){_.each(this.attributes.options,function(option){var optionEl=$("<input>").attr({type:"checkbox",value:option,name:self.attributes.name,id:option,"data-field":"array"}).html(option);var labelEl=$("<label>").attr("for",option).html(option);if(_.contains(self.attributes.value,option)){optionEl.attr("checked","checked")}self.$el.append(optionEl);self.$el.append(labelEl)})}this.$el.bind("change",function(e){var selected=$(e.target).val();if(!$(e.target).attr("checked")){self.model.set(self.attributes.name,_.difference(self.model.get(self.attributes.name),selected),{silent:true})}})}}),textarea:jumpui.internal.AbstractView.extend({tagName:"textarea"})};jumpui.fragment.FormFooter=jumpui.internal.AbstractView.extend({tagName:"div",attributes:{"class":"ui-body"},initialize:function(submitButton,resetButton){this.submit=submitButton;this.reset=resetButton},render:function(){var wrap=$("<fieldset>").attr("class","ui-grid-a");if(this.submit.show){var submitBtn=$("<div>").addClass("ui-block-a").append(new jumpui.fragment.formItems.submit({value:this.submit.label}).$el);wrap.append(submitBtn)}if(this.reset.show){var resetBtn=$("<div>").addClass("ui-block-b").append(new jumpui.fragment.formItems.reset({value:this.reset.label}).$el);wrap.append(resetBtn)}this.$el.append(wrap);return this.$el}});jumpui.fragment.Form=jumpui.Fragment.extend({model:undefined,items:undefined,itemsEl:[],submitButton:{show:true,label:"Submit"},resetButton:{show:true,label:"Cancel"},formFooter:jumpui.fragment.FormFooter,events:{"submit form":"submit"},init:function(){var self=this;this.options=_.defaults({action:"javascript:;"});this.model.on("error",function(model,error){self.errorEl.html(error);self.errorEl.show()})},_createItem:function(formItem,parentEl){var wrap=$("<div>").attr("data-role","fieldcontain");wrap.append($("<label>").attr("for",formItem.name).text(formItem.label));formItem.value=this.model.get(formItem.name);formItem.id=formItem.name;var elementAttrs=_.extend(formItem,formItem.data||{});var inputView=new jumpui.fragment.formItems[formItem.type]({attributes:_.extend(elementAttrs,jumpui.fragment.formItems[formItem.type].prototype.attributes),model:this.model});this.itemsEl.push(inputView);inputView.$el.bind("change",function(){});inputView.render();wrap.append(inputView.$el);return wrap},getContainer:function(){this.errorEl=$("<div class='error'>this is error</div>");this.$el.append(this.errorEl);var form=$("<form></form>").attr("action",this.options.action);return form},render:function(){var el=this.getContainer();var self=this;_.each(this.items,function(formItem){var itemView=self._createItem(formItem,el);el.append(itemView)});el.append(new this.formFooter(this.submitButton,this.resetButton).render());this.$el.append(el)},getValues:function(){return jumpui.util.serializeForm(this.$el)},submit:function(){this.errorEl.hide();var values=this.getValues();if(this.model.set(values)){if(this.onSubmit)this.onSubmit()}}});jumpui.fragment.List=jumpui.Fragment.extend({collection:undefined,ItemView:undefined,options:{inset:false},init:function(){_.bindAll(this,"refresh");if(this.collection===undefined){throw"Collection is null"}this.collection.on("reset",this.refresh);this.collection.on("add",this.refresh);this.collection.on("remove",this.refresh)},refresh:function(){this.render();this.$("ul").listview()},getModel:function(){return{list:this.collection.toJSON()}},getContainer:function(){var el=$("<ul></ul>");el.attr("data-role","listview");el.attr("data-inset",this.options.inset);return el},render:function(){this.$el.empty();var container=this.getContainer();var self=this;var templateEngine=this.block.page.app.templateEngine;this.collection.each(function(item){var itemView=new self.ItemView({model:item,templateEngine:templateEngine});itemView.render();container.append(itemView.$el)});this.$el.append(container)}});